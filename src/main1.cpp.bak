#include <Arduino.h>
#include <DHT.h>
#include <IRremote.h>
#include <SoftwareSerial.h>
#include <string.h>

// DHT11 设置
#define DHTPIN 2
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// 蓝牙/WiFi 模块 (SoftwareSerial)
// 我们复用之前的软串口定义，现在它连接的是 ESP-01
// RX (Arduino Pin 10) -> ESP-01 TX
// TX (Arduino Pin 11) -> ESP-01 RX
SoftwareSerial wifiSerial(10, 11);

// --- 补充缺失的定义 ---
#define IR_RECEIVE_PIN 3 // 将红外接收脚改为 3，避免与 WiFi (11) 冲突
#define IN1 6            // 电机驱动 IN1 (PWM)
#define IN2 7            // 电机驱动 IN2

// 全局变量
int fanSpeed = 0;
bool manualOverride = false;
float tempThreshold = 28.0;

// ----------------- 红外按键映射（可按需修改） -----------------
// 下面这组 command 值是常见 21 键 NEC 遥控器的“命令字节”。
// 不同遥控器可能不同：若不匹配，请先打开串口监视器查看打印出来的 IR cmd，再改这里。
#define IR_CMD_0 0x42
#define IR_CMD_1 0x16
#define IR_CMD_2 0x19
#define IR_CMD_3 0xD
#define IR_CMD_4 0xC
#define IR_CMD_5 0x18
#define IR_CMD_6 0x5E
#define IR_CMD_7 0x8
#define IR_CMD_8 0x1C
#define IR_CMD_9 0x5A
// 69
#define IR_CMD_VOL_MINUS 0x07 // 作为“减速”
#define IR_CMD_VOL_PLUS 0x09  // 作为“加速”
#define IR_CMD_100_PLUS 0x4A  // 设为 100%
#define IR_CMD_200_PLUS 0x45  // 切换 AUTO/MANUAL

static inline int pwmToPercent(int pwm)
{
  return constrain(map(constrain(pwm, 0, 255), 0, 255, 0, 100), 0, 100);
}

static inline int percentToPwm(int percent)
{
  return constrain(map(constrain(percent, 0, 100), 0, 100, 0, 255), 0, 255);
}

static void setFanSpeedPercent(int percent)
{
  manualOverride = true;
  fanSpeed = percentToPwm(percent);
  Serial.print("[IR] Set Speed: ");
  Serial.print(percent);
  Serial.println("%");
}

static void adjustFanSpeedPercent(int delta)
{
  int current = pwmToPercent(fanSpeed);
  setFanSpeedPercent(current + delta);
}

// WiFi 配置
const char *ssid = "vfemad";
const char *password = "88888888";
// 电脑端的 IP 地址
// 请务必修改下面的 IP !!!
const char *pc_ip = "192.168.90.66";
const int pc_port = 8080;

void sendATCommand(String cmd, int waitTime)
{
  Serial.print("CMD: ");
  Serial.println(cmd);
  wifiSerial.println(cmd);
  delay(waitTime);

  bool received = false;
  while (wifiSerial.available())
  {
    char c = wifiSerial.read();
    Serial.write(c);
    received = true;
  }
  if (!received)
  {
    Serial.println("[No Response]");
  }
  else
  {
    Serial.println(); // Newline after response
  }
}

void setup()
{
  Serial.begin(9600);
  pinMode(13, OUTPUT); // 内置 LED 用于指示状态

  // --- 暴力修改波特率逻辑 ---
  // 1. 假设 ESP 在 115200，尝试发送修改指令
  wifiSerial.begin(115200);
  Serial.println("Attempting to force ESP-01 to 9600 baud (Blind Send)...");
  // 尝试退出透传模式 (以防万一)
  wifiSerial.print("+++");
  delay(1100);

  for (int i = 0; i < 3; i++)
  {
    wifiSerial.println("AT+UART_DEF=9600,8,1,0,0");
    delay(200);
    wifiSerial.println("AT+CIOBAUD=9600");
    delay(200);
  }
  wifiSerial.end();
  delay(500);

  // 2. 切换到 9600，正式开始
  wifiSerial.begin(9600);
  wifiSerial.setTimeout(100); // 设置超时为 100ms，避免 readStringUntil 阻塞太久
  Serial.println("Initializing WiFi at 9600 baud...");

  // 再次尝试退出透传模式 (如果之前是在 9600 下透传)
  wifiSerial.print("+++");
  delay(1100);

  // 测试通信
  sendATCommand("AT", 1000);
  sendATCommand("AT+RST", 3000); // 复位让波特率生效
  sendATCommand("AT+CWMODE=1", 1000);

  String joinCmd = "AT+CWJAP=\"" + String(ssid) + "\",\"" + String(password) + "\"";
  sendATCommand(joinCmd, 8000); // 连接 WiFi (给足时间)

  // 获取 IP 地址
  sendATCommand("AT+CIFSR", 1000);

  // 开启 UDP 传输 (连接到电脑)
  String startCmd = "AT+CIPSTART=\"UDP\",\"" + String(pc_ip) + "\"," + String(pc_port);
  sendATCommand(startCmd, 2000);
  sendATCommand("AT+CIPMODE=1", 1000); // 开启透传模式
  sendATCommand("AT+CIPSEND", 1000);   // 开始发送数据

  // 初始化 DHT
  dht.begin();
  // 初始化 红外
  IrReceiver.begin(IR_RECEIVE_PIN, ENABLE_LED_FEEDBACK);

  // 初始化 电机引脚
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
}

unsigned long lastSendTime = 0;

void loop()
{
  // 心跳指示：每次循环闪烁一下 LED，证明程序没卡死
  // 由于循环现在很快，我们需要降频闪烁，否则看不清
  static unsigned long lastBlinkTime = 0;
  if (millis() - lastBlinkTime > 500)
  {
    lastBlinkTime = millis();
    digitalWrite(13, !digitalRead(13));
  }

  // --- 1. 优先处理 WiFi 指令 (非阻塞) ---
  if (wifiSerial.available())
  {
    String wifiCmd = wifiSerial.readStringUntil('\n');
    wifiCmd.trim();        // 去除首尾空格
    wifiCmd.toUpperCase(); // 转大写

    if (wifiCmd.length() > 0)
    {
      // [DEBUG] 回显指令
      wifiSerial.print("CMD_RECV: ");
      wifiSerial.println(wifiCmd);
      Serial.print("WiFi CMD: ");
      Serial.println(wifiCmd);

      if (wifiCmd == "AUTO")
      {
        manualOverride = false;
        Serial.println("Mode: AUTO");
        wifiSerial.println("OK: Mode set to AUTO");
      }
      else if (wifiCmd == "MANUAL")
      {
        manualOverride = true;
        Serial.println("Mode: MANUAL");
        wifiSerial.println("OK: Mode set to MANUAL");
      }
      else if (wifiCmd.startsWith("SPEED:"))
      {
        int splitIndex = wifiCmd.indexOf(':');
        if (splitIndex > 0)
        {
          String valStr = wifiCmd.substring(splitIndex + 1);
          int newSpeed = valStr.toInt();
          manualOverride = true;
          fanSpeed = constrain(newSpeed, 0, 255);
          Serial.print("Set Speed: ");
          Serial.println(fanSpeed);
          wifiSerial.print("OK: Speed set to ");
          wifiSerial.println(fanSpeed);
        }
      }
    }
  }

  // --- 2. 处理红外遥控信号 (非阻塞) ---
  if (IrReceiver.decode())
  {
    auto &data = IrReceiver.decodedIRData;
    const uint8_t command = data.command;
    const bool isRepeat = (data.flags & IRDATA_FLAGS_IS_REPEAT);

    if (data.protocol != UNKNOWN)
    {
      Serial.print("[IR] Protocol: ");
      Serial.print(data.protocol);
      Serial.print(" | cmd: 0x");
      Serial.print(command, HEX);
      if (isRepeat)
        Serial.print(" (REPEAT)");
      Serial.println();

      // 200+：切换模式
      if (command == IR_CMD_200_PLUS)
      {
        manualOverride = !manualOverride;
        Serial.print("[IR] Mode -> ");
        Serial.println(manualOverride ? "MANUAL" : "AUTO");
      }

      // 数字键：直接设置百分比（1-9 -> 10%-90%，0 -> 0%）
      if (!isRepeat)
      {
        if (command == IR_CMD_0)
          setFanSpeedPercent(0);
        else if (command == IR_CMD_1)
          setFanSpeedPercent(10);
        else if (command == IR_CMD_2)
          setFanSpeedPercent(20);
        else if (command == IR_CMD_3)
          setFanSpeedPercent(30);
        else if (command == IR_CMD_4)
          setFanSpeedPercent(40);
        else if (command == IR_CMD_5)
          setFanSpeedPercent(50);
        else if (command == IR_CMD_6)
          setFanSpeedPercent(60);
        else if (command == IR_CMD_7)
          setFanSpeedPercent(70);
        else if (command == IR_CMD_8)
          setFanSpeedPercent(80);
        else if (command == IR_CMD_9)
          setFanSpeedPercent(90);
        else if (command == IR_CMD_100_PLUS)
          setFanSpeedPercent(100);
      }

      // 音量键：加/减速（允许按住连发）
      if (command == IR_CMD_VOL_PLUS)
        adjustFanSpeedPercent(+10);
      else if (command == IR_CMD_VOL_MINUS)
        adjustFanSpeedPercent(-10);
    }
    IrReceiver.resume();
  }

  // --- 3. 定时任务：读取传感器、逻辑控制、发送数据 (每2秒一次) ---
  if (millis() - lastSendTime > 2000)
  {
    lastSendTime = millis();

    // 3.1 读取温湿度
    float h = dht.readHumidity();
    float t = dht.readTemperature();
    if (isnan(h) || isnan(t))
    {
      Serial.println("DHT read failed");
      // 保持上次的值或设为0
    }

    // 3.2 逻辑控制 (自动模式)
    if (!manualOverride && !isnan(t))
    {
      if (t >= tempThreshold)
      {
        int baseSpeed = 128;
        float excessTemp = t - tempThreshold;
        int dynamicSpeed = baseSpeed + (excessTemp * 25);
        fanSpeed = constrain(dynamicSpeed, 0, 255);
      }
      else
      {
        fanSpeed = 0;
      }
    }

    // 3.3 更新电机
    analogWrite(IN1, fanSpeed);
    digitalWrite(IN2, LOW);

    // 3.4 发送状态到 WiFi
    String statusMsg = "Temp: " + String(t, 1) + "C | Hum: " + String(h, 1) + "% | Set: " + String(tempThreshold) + "C | Mode: " + (manualOverride ? "MAN" : "AUTO") + " | Speed: " + String(map(fanSpeed, 0, 255, 0, 100)) + "%";

    Serial.println(statusMsg);
    wifiSerial.println(statusMsg);
  }
}
